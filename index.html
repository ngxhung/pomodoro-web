<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Focus - Liquid Pomodoro</title>
    
    <!-- 1. Cài đặt Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cấu hình Tailwind (Animation & Custom Styles) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    keyframes: {
                        'expand-panel': {
                            'from': { opacity: '0', transform: 'scale(0.5) translate(100px, 100px)' },
                            'to': { opacity: '1', transform: 'scale(1) translate(0, 0)' }
                        },
                        'expand-panel-left': {
                            'from': { opacity: '0', transform: 'scale(0.5) translate(-100px, 100px)' },
                            'to': { opacity: '1', transform: 'scale(1) translate(0, 0)' }
                        },
                        'typing': {
                            '0%, 80%, 100%': { transform: 'scale(0)' },
                            '40%': { transform: 'scale(1)' }
                        }
                    },
                    animation: {
                        'expand-settings': 'expand-panel 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'expand-ai': 'expand-panel-left 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- 3. Cài đặt React & Babel (Để chạy code React trực tiếp trên trình duyệt) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- CSS Bổ sung cho hiệu ứng kính -->
    <style>
        body { background: #000; overflow: hidden; }
        
        .glass-element {
            /* Nền kính */
            background: linear-gradient(135deg, rgba(255, 255, 255, calc(var(--glass-opacity, 0.1) + 0.1)) 0%, rgba(255, 255, 255, var(--glass-opacity, 0.1)) 100%);
            backdrop-filter: blur(12px) saturate(160%) contrast(110%);
            -webkit-backdrop-filter: blur(12px) saturate(160%) contrast(110%);
            border-top: 1px solid rgba(255, 255, 255, 0.4);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), inset 1px 1px 2px rgba(255, 255, 255, 0.3), inset -5px -5px 15px rgba(0, 0, 0, 0.05), inset 5px 5px 15px rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        .glass-pill { border-radius: 9999px !important; }
        
        .glass-button {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(8px) saturate(180%);
            -webkit-backdrop-filter: blur(8px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-left: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1), inset 2px 2px 5px rgba(255,255,255,0.4), inset -2px -2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .glass-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15), inset 2px 2px 8px rgba(255,255,255,0.6);
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
        }
        .glass-button:active { transform: translateY(1px) scale(0.98); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .glass-pill-bg { background: rgba(255, 255, 255, 0.25); box-shadow: 0 4px 15px rgba(0,0,0,0.1); backdrop-filter: blur(4px); }
        .text-shadow-lg { text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: inset 1px 1px 4px rgba(0,0,0,0.1); color: inherit;
        }
        .glass-input:focus { background: rgba(0, 0, 0, 0.2); outline: none; border-color: rgba(255, 255, 255, 0.5); }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.8); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.3); border-radius: 2px; }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 4. CODE REACT CHÍNH -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Play, Pause, RotateCcw, Settings, Upload, Check, Clock, Palette, Sun, Eye, Type, X, Sparkles, Brain, ListTodo } from 'lucide-react';

        const App = () => {
            // --- CONFIG ---
            // QUAN TRỌNG: Bạn cần điền API Key của mình vào đây để dùng tính năng AI
            const apiKey = "AIzaSyARu04JPaC7ZTgJvNcIBk2PjmgKqMg1IMs"; 

            const [durations, setDurations] = useState({ focus: 45, shortBreak: 5, longBreak: 15 });
            const MODES = {
                focus: { id: 'focus', label: 'Tập trung' },
                shortBreak: { id: 'shortBreak', label: 'Nghỉ ngắn' },
                longBreak: { id: 'longBreak', label: 'Nghỉ dài' },
            };
            const modeKeys = Object.keys(MODES);

            const [mode, setMode] = useState('focus');
            const [timeLeft, setTimeLeft] = useState(durations.focus * 60);
            const [isActive, setIsActive] = useState(false);
            const timerRef = useRef(null);

            const [bgType, setBgType] = useState('video');
            const [bgUrl, setBgUrl] = useState('./video.mp4');
            const [customInput, setCustomInput] = useState('');
            
            const [bgBrightness, setBgBrightness] = useState(0.4);
            const [bgBlur, setBgBlur] = useState(0); 
            const [textColor, setTextColor] = useState('#cccccc');
            const [glassOpacity, setGlassOpacity] = useState(0.1);
            
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('timer');

            // AI State
            const [isAIOpen, setIsAIOpen] = useState(false);
            const [aiTab, setAiTab] = useState('plan'); 
            const [userGoal, setUserGoal] = useState('');
            const [aiResponse, setAiResponse] = useState(null);
            const [isLoadingAI, setIsLoadingAI] = useState(false);
            const [currentTask, setCurrentTask] = useState(''); 
            
            const soundEnabled = true;

            // --- AI Logic ---
            const callGemini = async (prompt) => {
                if (!apiKey) {
                    setAiResponse("Vui lòng nhập API Key trong code (dòng 92) để sử dụng tính năng này.");
                    return;
                }
                setIsLoadingAI(true);
                setAiResponse(null);
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        }
                    );
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    setAiResponse(text || "Xin lỗi, AI đang bận.");
                } catch (error) {
                    console.error(error);
                    setAiResponse("Lỗi kết nối AI.");
                } finally {
                    setIsLoadingAI(false);
                }
            };

            const handleGeneratePlan = () => {
                if (!userGoal.trim()) return;
                const prompt = `Tôi có mục tiêu là: "${userGoal}". Hãy chia nhỏ mục tiêu này thành 3-5 đầu việc cụ thể (25-45p/việc). Chỉ trả về danh sách gạch đầu dòng, tiếng Việt.`;
                callGemini(prompt);
            };

            const handleGetTips = () => {
                const context = mode === 'focus' ? "đang tập trung" : "đang nghỉ giải lao";
                const prompt = `Người dùng ${context}. Cho 1 lời khuyên ngắn (<30 từ) về sức khoẻ/động lực. Tiếng Việt.`;
                callGemini(prompt);
            };

            // --- Timer Logic ---
            useEffect(() => { if (!isActive) setTimeLeft(durations[mode] * 60); }, [durations, mode]);

            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    timerRef.current = setInterval(() => setTimeLeft((prev) => prev - 1), 1000);
                } else if (timeLeft === 0) {
                    clearInterval(timerRef.current);
                    setIsActive(false);
                    if (soundEnabled) playNotificationSound();
                }
                return () => clearInterval(timerRef.current);
            }, [isActive, timeLeft, soundEnabled]);

            useEffect(() => {
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                document.title = `${m}:${s < 10 ? '0' : ''}${s} - Zen Focus`;
            }, [timeLeft]);

            const toggleTimer = () => setIsActive(!isActive);
            const resetTimer = () => { setIsActive(false); setTimeLeft(durations[mode] * 60); };
            const changeMode = (newMode) => { setMode(newMode); setIsActive(false); setTimeLeft(durations[newMode] * 60); };
            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            };
            
            const handleDurationChange = (key, val) => {
                const v = parseInt(val);
                if (!isNaN(v) && v > 0) setDurations(prev => ({ ...prev, [key]: v }));
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setBgUrl(URL.createObjectURL(file));
                    setBgType(file.type.startsWith('video') ? 'video' : 'image');
                    setCustomInput('');
                }
            };

            const playNotificationSound = () => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = 'sine'; osc.frequency.value = 880; gain.gain.value = 0.1;
                osc.start(); setTimeout(() => osc.stop(), 500);
            };

            // CSS Variables dynamic injection
            const styleVars = { '--glass-opacity': glassOpacity, color: textColor };

            return (
                <div className="relative min-h-screen w-full overflow-hidden flex flex-col items-center justify-center font-sans text-white" style={styleVars}>
                    
                    {/* BACKGROUND */}
                    <div className="absolute inset-0 z-0 bg-black">
                        <div className="w-full h-full transition-all duration-700" style={{ filter: `brightness(${bgBrightness}) blur(${bgBlur}px)`, transform: `scale(${1 + bgBlur/100})` }}>
                            {bgType === 'video' ? <video key={bgUrl} className="w-full h-full object-cover" autoPlay loop muted playsInline src={bgUrl}/> : <img src={bgUrl} alt="Bg" className="w-full h-full object-cover"/>}
                        </div>
                    </div>

                    {/* MAIN UI */}
                    <div className="relative z-10 w-full max-w-lg px-4 flex flex-col items-center gap-8 text-custom">
                        
                        {/* Header */}
                        <div className="w-full flex justify-center items-center mb-2">
                            <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${isActive ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`}></div>
                                <span className="text-sm font-medium tracking-widest uppercase opacity-80 text-shadow-lg">Zen Focus</span>
                            </div>
                        </div>

                        {/* SETTINGS PANEL */}
                        {isSettingsOpen && (
                            <div className="w-full glass-element rounded-3xl p-6 animate-expand-settings backdrop-blur-2xl absolute z-50 bottom-24 shadow-2xl border border-white/40 overflow-hidden" style={{ transformOrigin: 'calc(100% - 3rem) 100%' }}>
                                <div className="flex justify-between items-center mb-6 border-b border-white/10 pb-2">
                                    <div className="flex gap-4">
                                        <button onClick={() => setActiveTab('timer')} className={`text-xs font-bold uppercase tracking-wider ${activeTab === 'timer' ? 'opacity-100 border-b-2 border-white' : 'opacity-50'}`}>Thời gian</button>
                                        <button onClick={() => setActiveTab('bg')} className={`text-xs font-bold uppercase tracking-wider ${activeTab === 'bg' ? 'opacity-100 border-b-2 border-white' : 'opacity-50'}`}>Hình nền</button>
                                        <button onClick={() => setActiveTab('style')} className={`text-xs font-bold uppercase tracking-wider ${activeTab === 'style' ? 'opacity-100 border-b-2 border-white' : 'opacity-50'}`}>Giao diện</button>
                                    </div>
                                    <button onClick={() => setIsSettingsOpen(false)} className="hover:rotate-90 transition-transform"><X size={18}/></button>
                                </div>
                                
                                {activeTab === 'timer' && (
                                    <div className="grid grid-cols-3 gap-4 mb-2 animate-in fade-in duration-300">
                                        {modeKeys.map(k => (
                                            <div key={k} className="flex flex-col gap-2">
                                                <label className="text-xs opacity-60 ml-1 font-semibold">{MODES[k].label}</label>
                                                <input type="number" value={durations[k]} onChange={(e) => handleDurationChange(k, e.target.value)} className="glass-input w-full rounded-xl px-3 py-2 text-center text-sm font-medium"/>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                {activeTab === 'bg' && (
                                    <div className="space-y-4 animate-in fade-in duration-300">
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="Link ảnh/video..." value={customInput} onChange={(e) => setCustomInput(e.target.value)} className="glass-input flex-1 rounded-xl px-3 py-2 text-sm"/>
                                            <button onClick={() => { if(customInput) { setBgUrl(customInput); setBgType(customInput.match(/\.(mp4|webm|ogg)$/i) ? 'video':'image'); }}} className="glass-button px-3 rounded-xl"><Check size={18}/></button>
                                        </div>
                                        <div className="relative group">
                                            <div className="w-full glass-button border-dashed flex items-center justify-center gap-2 py-3 rounded-xl hover:bg-white/10 transition-colors"><Upload size={16}/> <span className="text-sm font-medium">Tải file lên</span></div>
                                            <input type="file" accept="image/*,video/*" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50"/>
                                        </div>
                                        <div className="space-y-4 mt-4 pt-4 border-t border-white/10">
                                            <div className="flex items-center justify-between"><span className="text-xs uppercase font-bold opacity-80 flex gap-2"><Sun size={14}/> Độ sáng</span><input type="range" min="0" max="2" step="0.1" value={bgBrightness} onChange={(e)=>setBgBrightness(e.target.value)} className="w-1/2"/></div>
                                            <div className="flex items-center justify-between"><span className="text-xs uppercase font-bold opacity-80 flex gap-2"><Eye size={14}/> Độ mờ</span><input type="range" min="0" max="20" step="1" value={bgBlur} onChange={(e)=>setBgBlur(e.target.value)} className="w-1/2"/></div>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'style' && (
                                    <div className="space-y-4 animate-in fade-in duration-300">
                                        <div className="flex items-center justify-between"><span className="text-xs uppercase font-bold opacity-80 flex gap-2"><Palette size={14}/> Độ đục kính</span><input type="range" min="0" max="1" step="0.05" value={glassOpacity} onChange={(e)=>setGlassOpacity(e.target.value)} className="w-1/2"/></div>
                                        <div className="flex items-center justify-between"><span className="text-xs uppercase font-bold opacity-80 flex gap-2"><Type size={14}/> Màu chữ</span><input type="color" value={textColor} onChange={(e)=>setTextColor(e.target.value)} className="w-8 h-8 rounded-full cursor-pointer bg-transparent border border-white/30 p-0 shadow-sm"/></div>
                                        <div className="pt-2 text-right"><button onClick={()=>{setBgBrightness(0.8);setBgBlur(0);setTextColor('#ffffff');setGlassOpacity(0)}} className="text-xs underline opacity-50 hover:opacity-100">Mặc định</button></div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* AI PANEL */}
                        {isAIOpen && (
                            <div className="w-full glass-element rounded-3xl p-6 animate-expand-ai backdrop-blur-2xl absolute z-50 bottom-24 shadow-2xl border border-white/40 overflow-hidden" style={{ transformOrigin: '3rem 100%' }}>
                                <div className="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                                    <div className="flex items-center gap-2"><Sparkles className="text-yellow-300" size={18}/><span className="text-sm font-bold uppercase tracking-wider">Trợ lý Zen AI</span></div>
                                    <button onClick={() => setIsAIOpen(false)} className="hover:rotate-90 transition-transform"><X size={18}/></button>
                                </div>
                                <div className="flex mb-4 bg-black/10 rounded-xl p-1">
                                    <button onClick={()=>{setAiTab('plan');setAiResponse(null)}} className={`flex-1 py-2 text-xs font-bold rounded-lg ${aiTab==='plan'?'bg-white/20 shadow':'opacity-60'}`}>Kế hoạch</button>
                                    <button onClick={()=>{setAiTab('tips');setAiResponse(null);handleGetTips()}} className={`flex-1 py-2 text-xs font-bold rounded-lg ${aiTab==='tips'?'bg-white/20 shadow':'opacity-60'}`}>Lời khuyên</button>
                                </div>
                                {aiTab === 'plan' && (
                                    <div className="flex gap-2 mb-3">
                                        <input type="text" placeholder="Mục tiêu..." value={userGoal} onChange={(e)=>setUserGoal(e.target.value)} onKeyDown={(e)=>e.key==='Enter'&&handleGeneratePlan()} className="glass-input flex-1 rounded-xl px-3 py-2 text-sm"/>
                                        <button onClick={handleGeneratePlan} disabled={isLoadingAI} className="glass-button p-2 rounded-xl bg-blue-500/20">{isLoadingAI?<Brain size={18} className="animate-pulse"/>:<ListTodo size={18}/>}</button>
                                    </div>
                                )}
                                <div className="mt-2 p-3 bg-white/5 rounded-xl border border-white/10 text-sm leading-relaxed max-h-60 overflow-y-auto custom-scrollbar">
                                    {isLoadingAI ? <div className="flex justify-center gap-1 py-4"><div className="w-2 h-2 bg-white rounded-full typing-dot"></div><div className="w-2 h-2 bg-white rounded-full typing-dot"></div><div className="w-2 h-2 bg-white rounded-full typing-dot"></div></div> : (aiResponse || <span className="opacity-50 text-xs">...</span>)}
                                </div>
                            </div>
                        )}

                        {/* MODE SELECTOR */}
                        <div className="glass-element glass-pill p-1.5 flex w-full max-w-sm relative overflow-hidden">
                            <div className="absolute top-1.5 bottom-1.5 glass-pill-bg rounded-full transition-all duration-300 ease-out" style={{ width: 'calc(33.33% - 8px)', left: `calc(${modeKeys.indexOf(mode) * 33.33}% + 4px)` }}/>
                            {Object.entries(MODES).map(([key, m]) => (
                                <button key={key} onClick={() => changeMode(key)} className={`flex-1 py-3 text-sm font-bold rounded-full relative z-10 transition-colors duration-300 ${mode === key ? 'text-inherit' : 'opacity-60 hover:opacity-100'}`} style={{color: 'inherit'}}>
                                    {m.label}
                                </button>
                            ))}
                        </div>

                        {/* TIMER */}
                        <div className="relative py-8">
                            <div className="text-[9rem] leading-none font-light tracking-tighter select-none tabular-nums relative z-10 drop-shadow-2xl">{formatTime(timeLeft)}</div>
                            <div className="text-center opacity-70 text-sm tracking-[0.3em] font-light uppercase mt-2">{isActive ? 'Đang tập trung' : 'Sẵn sàng?'}</div>
                        </div>

                        {/* CONTROLS */}
                        <div className="flex items-center gap-6 justify-center w-full">
                            <button onClick={()=>{setIsAIOpen(!isAIOpen);setIsSettingsOpen(false)}} className={`glass-button w-16 h-16 rounded-full flex items-center justify-center opacity-90 hover:opacity-100 ${isAIOpen?'bg-yellow-400/20 text-yellow-200 shadow-[0_0_20px_rgba(253,224,71,0.3)]':''}`}><Sparkles size={22} className={isAIOpen?'animate-pulse':''}/></button>
                            <button onClick={resetTimer} className="glass-button w-16 h-16 rounded-full flex items-center justify-center opacity-90 hover:opacity-100"><RotateCcw size={22}/></button>
                            <button onClick={toggleTimer} className={`glass-button w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 border-2 ${isActive?'bg-white/20 border-white/60 shadow-[0_0_20px_rgba(255,255,255,0.2)]':'bg-white/5 border-white/40'}`}>
                                {isActive ? <Pause size={24} fill="currentColor" className="opacity-90"/> : <Play size={24} fill="currentColor" className="ml-1 opacity-90"/>}
                            </button>
                            <button onClick={()=>{setIsSettingsOpen(!isSettingsOpen);setIsAIOpen(false)}} className={`glass-button w-16 h-16 rounded-full flex items-center justify-center opacity-90 hover:opacity-100 transition-all duration-500 ${isSettingsOpen?'bg-white/30 rotate-90 scale-90':''}`}><Settings size={22}/></button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
